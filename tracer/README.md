# C tracer

Uses GDB (GNU DeBugger). Outputs XML of the program trace to `logs/` and text output of the program `outputs/`.
Tested with `GNU gdb (GDB) 8.2`.

## How to generate traces

Run this command to compile and run the solution programs to generate traces.
The expected outputs are included, but keep in mind that these expected outputs were generated by running on a small sample of the data and, though the structure of the output should be the same, you should expect different execution time/numbers in the outputs.

```bash
# compile all solutions for all problems
$ python 01_preprocess/compile_all.py --begin_problem 0 --end_problem 4052
problems: 100%|██████████████████████████████████████████████████████████| 4052/4052 [09:15<00:00, 555.64s/it]
rows: 100%|██████████████████████████████████████████████████████████████| 10080/10080 [09:15<00:00, 18.15it/s]
INFO:root:p00000 outcome
compile_error    6054
success          4026
...
Name: count, dtype: int64

# trace one solution for one problem
$ mkdir -p run
$ python 02_trace/analyze.py compile_output/ p00000 C s000552118 all_input_output/p00000/input_0.txt run/ --verbose 1
p00000/C/s000552118 input_0.txt 2024-02-07T09:16:37 DEBUG args=Namespace(exe_dir='compile_output/', problem_id='p00000', language='C', submission_id='s000552118', input_file='all_input_output/p00000/input_0.txt', cwd_dir='run/', verbose=1, timeout=10) trace_py=/home/benjis/Code/trace-modeling_icse2024_recovery/trace_collection_c_cpp/02_trace/trace_asm.py
p00000/C/s000552118 input_0.txt 2024-02-07T09:16:37 INFO begin
p00000/C/s000552118 input_0.txt 2024-02-07T09:16:37 DEBUG subprocess args=gdb /home/benjis/Code/trace-modeling_icse2024_recovery/trace_collection_c_cpp/compile_output/p00000/C/s000552118 -batch -nh -ex "set logging file /dev/null" -ex "set logging redirect on" -ex "set logging on" -ex "set print elements unlimited" -ex "set print repeats unlimited" -ex "set max-value-size unlimited" -ex "source /home/benjis/Code/trace-modeling_icse2024_recovery/trace_collection_c_cpp/02_trace/trace_asm.py" -ex "start < /home/benjis/Code/trace-modeling_icse2024_recovery/trace_collection_c_cpp/all_input_output/p00000/input_0.txt > trace/p00000/C/s000552118/input_0.txt_stdout.txt" -ex "trace-asm trace/p00000/C/s000552118/input_0.txt_log.xml"
p00000/C/s000552118 input_0.txt 2024-02-07T09:16:41 INFO end
p00000/C/s000552118 input_0.txt 2024-02-07T09:16:41 INFO elapsed seconds: 3.617031
p00000/C/s000552118 input_0.txt 2024-02-07T09:16:41 INFO exit code: 0

# trace all solutions for all problems
for i in {00000..04052}
do
    bash 02_trace/trace_problem.sh compile_output/ run/ all_input_output/ "p${i}" C "-0"
done
```

## How to convert traces to `.jsonl` format

We use a script to read the trace in `.xml` format, combine it with the source code and inputs, and output pretraining data in `.jsonl` format.

```bash
# transform one XML to tree format
$ mkdir -p trace_tree
$ python 03_postprocess/transform_xml.py trace/p00000/C/s000552118/input_0.txt_log.xml --schema tree --output trace_tree/p00000/C/s000552118/input_0.txt_log.xml

# transform all XMLs to tree format
for i in {00000..04052}
do
    for f in $(ls "trace/p${i}/C/*/*_log.xml")
    do
        dst_f="trace_tree/$(realpath --relative-to trace $(dirname $f))"
        python 03_postprocess/transform_xml.py "$f" --schema tree --output "$dst_f"
    done
done

# convert all XMLs to JSONL format
$ python 03_postprocess/sequenceize_logs_from_metadata.py --lang C --base_dirs trace_tree --src_dirs ../Project_CodeNet/data --input_dir all_input_output --metadata_dir ../Project_CodeNet/metadata --begin_problem 0 --end_problem 4052 --limit_solutions 1 --output trace_tree_sequences
args=Namespace(lang='C', base_dirs=['trace_tree'], src_dirs=['../Project_CodeNet/data'], input_dir='all_input_output', metadata_dir='../Project_CodeNet/metadata', begin_problem=0, end_problem=0, limit_solutions=1, limit_sequences=None, nproc=1, output='trace_tree_sequences')

p00000.csv, total=16099, filtered=4849, excluded=11250
100%|█████████████████████████████████████████████████████████████████████| 4849/4849 [00:01<00:00, 3733.83it/s, missing_log=4848, success=1]
```
